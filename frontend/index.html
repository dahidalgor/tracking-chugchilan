<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Tracking Quilotoa ‚Äî Prototipo</title>

  <!-- GOOGLE FONTS -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800&family=Inter:wght@400;700;800&display=swap" rel="stylesheet" />

  <!-- LEAFLET + PLUGINS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-gpx@1.7.0"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

  <!-- ESTILOS -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- NAV -->
  <header>
    <div class="container nav">
      <nav class="menu" aria-label="principal">
        <a class="active" href="#hero">INICIO</a>
        <a href="#ruta">RUTA</a>
        <a href="#hospedaje">HOSPEDAJE</a>
        <a href="#actividades">ACTIVIDADES</a>
        <a href="#guias">GU√çAS</a>
        <a href="#contacto">CONTACTO</a>
      </nav>
      <div class="spacer"></div>
      <a class="cta" href="#ruta">Planificar ruta</a>
    </div>
  </header>

  <!-- HERO -->
  <section id="hero" class="hero" aria-label="Portada">
    <div class="hero-inner">
      <h1>TRACKING QUILOTOA</h1>
      <p>Caminar es solo el comienzo: vive la experiencia andina, comparte con su gente y guarda momentos que quedar√°n para siempre.</p>
      <a class="btn-primary" href="#actividades">Explorar</a>
    </div>
  </section>

  <div class="after-hero">

    <!-- RUTA con mapa avanzado -->
    <section id="ruta" class="section">
      <h2 class="title">LA RUTA</h2>
      <p class="subtitle">Explora el recorrido completo y planifica tus paradas favoritas.</p>
      <div class="container" style="position:relative;">
        <div id="map"></div>

        <div class="panel">
          <button id="btnFollow">üß≠ Seguir ON</button>
          <button id="btnLocate">üìç Mi ubicaci√≥n</button>
          <button id="btnCompass">üß≤ Br√∫jula</button>
        </div>

        <div class="legend">
          <span class="sw"></span>Ruta Quilotoa Trail
        </div>

        <div id="banner" class="banner">Te alejaste de la ruta (&gt;30 m)</div>
      </div>
    </section>

    <!-- HOSPEDAJE (sin filtros y sin t√≠tulos) -->
    <section id="hospedaje" class="section">
      <h2 class="title">Elige tu mejor opci√≥n para hospedarte y relajarte</h2>
      <div id="portfolio" class="container grid cols-4">
        <!-- CHUGCHILAN -->
        <article class="card">
          <a href="https://quilotoatrail.com/admin/establecimiento.php?id=10" target="_blank" rel="noopener">
            <img class="media" src="https://quilotoatrail.com/wp-content/uploads/2024/07/DSC_2355-min32-2-1024x683.jpg" alt="Hostal Cloud Forest">
          </a>
        </article>
        <article class="card">
          <a href="https://quilotoatrail.com/admin/establecimiento.php?id=14" target="_blank" rel="noopener">
            <img class="media" src="https://quilotoatrail.com/wp-content/uploads/2024/07/DSC_2355-min541057-1024x683.jpg" alt="Hoster√≠a Puyu Pacha">
          </a>
        </article>
        <article class="card">
          <a href="https://quilotoatrail.com/admin/establecimiento.php?id=11" target="_blank" rel="noopener">
            <img class="media" src="https://quilotoatrail.com/wp-content/uploads/2024/07/DSC_2355-min541024-1024x683.jpg" alt="Lagoon Hotel">
          </a>
        </article>
        <article class="card">
          <a href="https://quilotoatrail.com/admin/establecimiento.php?id=18" target="_blank" rel="noopener">
            <img class="media" src="https://quilotoatrail.com/wp-content/uploads/2024/07/DSC_2355-min541016-1024x683.jpg" alt="Centro Tur√≠stico Quilotoa √ëan">
          </a>
        </article>
        <article class="card">
          <a href="https://quilotoatrail.com/admin/establecimiento.php?id=13" target="_blank" rel="noopener">
            <img class="media" src="https://quilotoatrail.com/wp-content/uploads/2024/07/DSC_2355-min5410-1024x683.jpg" alt="Caba√±a Luna y Miel">
          </a>
        </article>
        <article class="card">
          <a href="https://quilotoatrail.com/admin/establecimiento.php?id=12" target="_blank" rel="noopener">
            <img class="media" src="https://quilotoatrail.com/wp-content/uploads/2024/07/DSC_2355-min51-1024x683.jpg" alt="Hostal Backpackers">
          </a>
        </article>
        <article class="card">
          <a href="https://quilotoatrail.com/admin/establecimiento.php?id=9" target="_blank" rel="noopener">
            <img class="media" src="https://quilotoatrail.com/wp-content/uploads/2024/07/DSC_2355-min19-1024x683.jpg" alt="Hostal Do√±a Clarita">
          </a>
        </article>
        <article class="card">
          <a href="https://quilotoatrail.com/admin/establecimiento.php?id=7" target="_blank" rel="noopener">
            <img class="media" src="https://quilotoatrail.com/wp-content/uploads/2024/07/DSC_2355-min17-1024x683.jpg" alt="El Bautista Camping">
          </a>
        </article>
        <!-- QUILOTOA -->
        <article class="card">
          <a href="https://quilotoatrail.com/admin/establecimiento.php?id=17" target="_blank" rel="noopener">
            <img class="media" src="https://quilotoatrail.com/wp-content/uploads/2024/07/DSC_1712-1024x683.jpg" alt="Hotel Princesa Toa">
          </a>
        </article>
      </div>
    </section>

    <!-- ACTIVIDADES -->
    <section id="actividades" class="section" style="background:#f3f7f9;">
      <h2 class="title">Vive estas experiencias</h2>
      <p class="subtitle">Programas aut√©nticos en granjas y paisajes andinos, operados por la comunidad.</p>
      <div class="container grid cols-4">
        <article class="card">
          <img class="media" src="https://cdn.pixabay.com/photo/2016/08/26/01/55/animals-1621075_1280.jpg" alt="Granja de animales">
        </article>
        <article class="card">
          <img class="media" src="https://panoramaagrario.com/wp-content/uploads/2016/06/cultivos.jpg" alt="Siembra">
        </article>
        <article class="card">
          <img class="media" src="https://www.micebo.es/data/blog/328/images/_mini/post_grd/891/pescar-trucha.jpg?t=20220422b" alt="Pesca deportiva">
        </article>
        <article class="card">
          <img class="media" src="https://losciruelos.es/wp-content/uploads/2017/02/montar-a-caballo-beneficios.jpg" alt="Montar a caballo">
        </article>
      </div>
    </section>

    <!-- GU√çAS -->
    <section id="guias" class="section">
      <h2 class="title">Gu√≠as locales certificados</h2>
      <p class="subtitle">Conocimiento de territorio, seguridad y acompa√±amiento en tu idioma.</p>
      <div class="container grid cols-3">
        <article class="card">
          <div class="guide">
            <img src="https://www.google.com/url?sa=i&url=https%3A%2F%2Fwww.ambiente.gob.ec%2Fmae-permite-el-ingreso-de-guias-nacionales-a-12-areas-protegidas-para-fomentar-y-promover-el-turismo%2F&psig=AOvVaw1Uh0UF5idTG937sY428sLr&ust=1761450717805000&source=images&cd=vfe&opi=89978449&ved=0CBUQjRxqFwoTCJiC1LW5vpADFQAAAAAdAAAAABAE" alt="Gu√≠a 1">
            <div><strong>Gu√≠a Local 1</strong><br><span class="subtitle">Espa√±ol / Ingl√©s</span></div>
          </div>
        </article>
        <article class="card">
          <div class="guide">
            <img src="https://ecuadorconventions.org/wp-content/uploads/2025/01/Guianza-Turistica.webp" alt="Gu√≠a 2">
            <div><strong>Gu√≠a Local 2</strong><br><span class="subtitle">Espa√±ol / Franc√©s</span></div>
          </div>
        </article>
        <article class="card">
          <div class="guide">
            <img src="https://travelecuador.org/wp-content/uploads/2022/06/Marco-I-have-a-Mission.jpg" alt="Gu√≠a 3">
            <div><strong>Gu√≠a Local 3</strong><br><span class="subtitle">Espa√±ol</span></div>
          </div>
        </article>
      </div>
    </section>

    <!-- CONTACTO -->
    <section id="contacto" class="section">
      <h2 class="title">¬øListo para empezar?</h2>
      <p class="subtitle">Escr√≠benos fechas, n√∫mero de personas y actividades que te interesan.</p>
      <div class="container" style="display:flex;justify-content:center">
        <a class="btn-primary" href="mailto:info@quilotoatrail.com">Contactar</a>
      </div>
    </section>

  </div>

  <!-- SCRIPT DEL MAPA AVANZADO -->
  <script>
    // ----- MAPA BASE -----
    const map = L.map('map', { zoomControl:true }).setView([-0.9, -78.8], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // ----- RUTA GPX -----
    const gpxUrl = 'quilotoa_trail.gpx';
    const gpxLayer = new L.GPX(gpxUrl, {
      async: true,
      polyline_options: { color:'#2563eb', weight:4, opacity:.95 }
    })
    .on('loaded', e => map.fitBounds(e.target.getBounds(), { padding:[30,30] }))
    .on('error', () => alert('No pude cargar ' + gpxUrl + '. ¬øNombre/ruta correctos?'))
    .addTo(map);

    // Convertimos a l√≠nea para alertas
    let routeLine = null;
    gpxLayer.on('loaded', () => {
      const gj = gpxLayer.toGeoJSON();
      routeLine = (gj.features || [gj]).find(f => f.geometry?.type === 'LineString') || null;
    });

    // ----- MARCADOR TRIANGULAR -----
    function makeHeadingIcon(angleDeg = 0) {
      return L.divIcon({
        className:'heading-icon',
        html:`
          <svg class="heading-shadow" viewBox="0 0 100 100" style="transform:rotate(${angleDeg}deg)">
            <path d="M50 6 L72 68 Q50 58 28 68 Z" fill="#1d4ed8" stroke="#0f3fb1" stroke-width="4" />
            <circle cx="50" cy="58" r="6" fill="#fff" opacity=".9"/>
          </svg>`,
        iconSize:[36,36],
        iconAnchor:[18,18],
      });
    }

    let headingDeg = null;
    let follow = true;
    let youMarker = null;
    let accuracyCircle = null;
    const banner = document.getElementById('banner');

    function showBanner(msg){
      banner.textContent = msg;
      banner.style.display='block';
      setTimeout(()=> banner.style.display='none', 2400);
    }

    function checkOffRoute(latlng){
      if (!routeLine) return;
      const p = turf.point([latlng.lng, latlng.lat]);
      const dist = turf.pointToLineDistance(p, routeLine, {units:'meters'});
      if (dist > 30) showBanner('Te alejaste de la ruta (~' + dist.toFixed(0) + ' m)');
    }

    // ----- GEOLOC (bot√≥n Mi ubicaci√≥n) -----
    document.getElementById('btnLocate').addEventListener('click', () => {
      map.locate({ watch:true, setView:true, maxZoom:17, enableHighAccuracy:true });
    });

    map.on('locationfound', (e) => {
      const latlng = e.latlng;

      if (!youMarker) {
        youMarker = L.marker(latlng, {
          icon: makeHeadingIcon(headingDeg ?? 0), zIndexOffset:1000
        }).addTo(map);
      } else {
        youMarker.setLatLng(latlng);
        const el = youMarker.getElement()?.querySelector('svg');
        if (el && headingDeg != null) el.style.transform = `rotate(${headingDeg}deg)`;
      }

      if (!accuracyCircle) {
        accuracyCircle = L.circle(latlng, {
          radius:e.accuracy||15,
          weight:1,
          color:'#2563eb',
          opacity:.6
        }).addTo(map);
      } else {
        accuracyCircle.setLatLng(latlng);
        accuracyCircle.setRadius(e.accuracy||15);
      }

      if (follow) map.setView(latlng, Math.max(map.getZoom(), 16), { animate:false });

      checkOffRoute(latlng);
    });

    map.on('locationerror', (e) => {
      alert(
        "‚ö†Ô∏è No se pudo obtener ubicaci√≥n.\n\n" +
        "Detalle: " + e.message + " (code " + e.code + ")\n\n" +
        "Prueba:\n" +
        "‚Ä¢ Abrir en navegador con HTTPS\n" +
        "‚Ä¢ Activar permisos de ubicaci√≥n\n" +
        "‚Ä¢ Activar Ubicaci√≥n precisa en el dispositivo"
      );
    });

    // ----- BR√öJULA -----
    function handleOrientation(ev){
      if (typeof ev.alpha === 'number') {
        headingDeg = 360 - ev.alpha;
        const el = youMarker?.getElement()?.querySelector('svg');
        if (el) el.style.transform = `rotate(${headingDeg}deg)`;
      }
    }

    async function enableCompass(){
      try {
        if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
          const state = await DeviceOrientationEvent.requestPermission();
          if (state !== 'granted') return alert('Permiso de br√∫jula denegado');
        }
        window.addEventListener('deviceorientation', handleOrientation, { passive:true });
        alert('Br√∫jula activada');
      } catch {
        alert('Tu navegador no permite br√∫jula');
      }
    }
    document.getElementById('btnCompass').onclick = enableCompass;

    // ----- Toggle seguir -----
    document.getElementById('btnFollow').onclick = (ev) => {
      follow = !follow;
      ev.target.textContent = follow ? "üß≠ Seguir ON" : "üß≠ Seguir OFF";
      showBanner(follow ? "Seguir activado" : "Seguir desactivado");
    };
  </script>
</body>
</html>

